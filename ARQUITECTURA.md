# ๐๏ธ Arquitectura de ScanProfit

## ๐ Diagrama de Arquitectura

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         FRONTEND (React)                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ                      App.tsx                              โ  โ
โ  โ  - Estado global de la aplicaciรณn                        โ  โ
โ  โ  - Gestiรณn de autenticaciรณn                              โ  โ
โ  โ  - Manejo de lista de productos                          โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                              โ                                   โ
โ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ โ
โ  โ  LoginScreen     โ  โ ProductScanner   โ  โ ProductTable โ โ
โ  โ  - Autenticaciรณn โ  โ - Input UPC      โ  โ - Lista      โ โ
โ  โ  - Validaciรณn    โ  โ - Escaneo        โ  โ - Eliminar   โ โ
โ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ โ
โ                              โ                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ              ProductDetails                              โ   โ
โ  โ  - Visualizaciรณn del producto actual                     โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        SERVICIOS                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  authService.ts      โ         โ  productService.ts      โ  โ
โ  โ  - loginEmployee     โ         โ  - fetchProductData     โ  โ
โ  โ  - logoutEmployee    โ         โ  - Llama Edge Function  โ  โ
โ  โ  - getCurrentEmployeeโ         โโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ                                        โ
โ            โ                              โ                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    SUPABASE BACKEND                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Supabase Auth       โ         โ  Edge Function          โ  โ
โ  โ  - JWT tokens        โ         โ  product-lookup         โ  โ
โ  โ  - Session mgmt      โ         โ                         โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ         โ  1. searchUPCDatabase   โ  โ
โ            โ                       โ     - OpenFoodFacts     โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ         โ     - UPCItemDB         โ  โ
โ  โ  PostgreSQL          โ         โ  2. generatePrice       โ  โ
โ  โ  Table: employees    โ         โ  3. generarFicha (AI)   โ  โ
โ  โ  - id (PK, FK)       โ         โ     - OpenAI GPT        โ  โ
โ  โ  - email             โ         โโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  - nombre_completo   โ                    โ                  โ
โ  โ  - puesto            โ         โโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  - departamento      โ         โ  External APIs          โ  โ
โ  โ  - activo            โ         โ  - OpenFoodFacts        โ  โ
โ  โ  - RLS enabled       โ         โ  - UPCItemDB            โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ         โ  - OpenAI               โ  โ
โ                                    โโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      EXPORTACIรN                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  csvExport.ts                                             โ  โ
โ  โ  - Convierte productos a CSV                              โ  โ
โ  โ  - UTF-8 con BOM (compatible Excel)                       โ  โ
โ  โ  - Descarga automรกtica                                    โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Flujo de Datos

### 1. **Autenticaciรณn**

```
Usuario โ LoginScreen โ authService.loginEmployee()
                              โ
                        Supabase Auth
                              โ
                        Verifica credenciales
                              โ
                        Query tabla employees
                              โ
                        Verifica empleado.activo
                              โ
                        Update last_login
                              โ
                        Return Employee data
                              โ
                        App.tsx actualiza estado
                              โ
                        Renderiza interfaz principal
```

### 2. **Bรบsqueda de Producto**

```
Usuario โ ProductScanner (ingresa UPC)
                โ
        handleScan(upc)
                โ
        productService.fetchProductData(upc)
                โ
        POST a Edge Function /product-lookup
                โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  Edge Function           โ
        โ  1. searchUPCDatabase    โ
        โ     โโ OpenFoodFacts     โ
        โ     โโ UPCItemDB         โ
        โ     โโ Fallback          โ
        โ  2. generateRealisticPriceโ
        โ  3. generarFichaProducto โ
        โ     โโ OpenAI GPT-4o-miniโ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ
        Return ProductData
                โ
        App.tsx actualiza:
        - currentProduct (detalles)
        - scannedProducts (lista)
                โ
        Renderiza:
        - ProductDetails
        - ProductTable
```

### 3. **Exportaciรณn a CSV**

```
Usuario โ Click "Generar Excel"
                โ
        handleExport()
                โ
        csvExport.exportToCSV(scannedProducts)
                โ
        1. Crear headers
        2. Mapear productos a rows
        3. Convertir a CSV
        4. Agregar BOM UTF-8
        5. Crear Blob
        6. Crear link de descarga
        7. Trigger descarga
                โ
        Archivo CSV descargado
```

---

## ๐๏ธ Modelo de Datos

### **Tabla: employees**

```sql
CREATE TABLE employees (
  id uuid PRIMARY KEY,              -- FK a auth.users(id)
  email text UNIQUE NOT NULL,
  nombre_completo text NOT NULL,
  puesto text DEFAULT 'Empleado',
  departamento text DEFAULT 'General',
  activo boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  last_login timestamptz
);
```

**Relaciones:**
- `id` โ `auth.users(id)` (ON DELETE CASCADE)

**Polรญticas RLS:**
```sql
-- Empleados pueden ver su propia informaciรณn
CREATE POLICY "Empleados pueden ver su propia informaciรณn"
  ON employees FOR SELECT
  TO authenticated
  USING (auth.uid() = id);

-- Empleados pueden actualizar su รบltimo login
CREATE POLICY "Empleados pueden actualizar su รบltimo login"
  ON employees FOR UPDATE
  TO authenticated
  USING (auth.uid() = id)
  WITH CHECK (auth.uid() = id);
```

**Trigger:**
```sql
-- Crear empleado automรกticamente al registrarse
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION handle_new_employee();
```

---

## ๐ฏ Interfaces TypeScript

### **Product**
```typescript
interface Product {
  upc: string;
  name?: string;
  nombre?: string;
  marca?: string;
  categoria?: string;
  descripcion?: string;
  peso?: string;
  dimensiones?: string;
  ingredientes?: string;
}
```

### **Employee**
```typescript
interface Employee {
  id: string;
  email: string;
  nombre_completo: string;
  puesto: string;
  departamento: string;
  activo: boolean;
  created_at: string;
  last_login?: string;
}
```

### **ProductData (Edge Function)**
```typescript
interface ProductData {
  upc: string;
  nombre: string;
  precioAmazon: number;
  precioWalmart: number;
  precioPromedio: number;
  descripcion: string;
  fichaTecnica: {
    marca: string;
    categoria: string;
    peso: string;
    origen: string;
    codigo_barras: string;
  };
  image?: string;
  leaderPrice: number;
}
```

---

## ๐ Seguridad

### **Frontend**
- Variables de entorno para credenciales (`.env`)
- No se exponen secrets en el cรณdigo
- Validaciรณn de entrada en formularios
- Protecciรณn de rutas (redirect a login si no autenticado)

### **Backend (Supabase)**
- **RLS (Row Level Security)** habilitado
- Polรญticas restrictivas por defecto
- JWT tokens para autenticaciรณn
- Anon key pรบblica (safe para frontend)
- Service role key privada (no se expone)

### **Edge Function**
- CORS configurado
- API keys en Supabase Secrets (no en cรณdigo)
- Rate limiting por Supabase (por defecto)
- Validaciรณn de parรกmetros

### **APIs Externas**
- OpenAI API key en server-side (Edge Function)
- Fallback cuando APIs fallan
- No se exponen API keys en frontend

---

## ๐ Performance

### **Optimizaciones Implementadas**

1. **Build Optimizado**
   - Vite bundle: ~87 KB gzipped
   - Tree shaking habilitado
   - CSS purging con TailwindCSS

2. **Lazy Loading**
   - Componentes cargados bajo demanda (puede mejorarse)
   - Assets optimizados

3. **Cachรฉ**
   - Supabase client cachรฉ de sesiรณn
   - Browser cachรฉ de assets estรกticos

### **Mรฉtricas**

| Mรฉtrica | Valor |
|---------|-------|
| Bundle JS | 292 KB (87 KB gzipped) |
| Bundle CSS | 17 KB (3.87 KB gzipped) |
| HTML | 0.47 KB |
| **Total** | **~91 KB gzipped** |

---

## ๐ Deployment

### **Frontend (Vercel/Netlify)**

```mermaid
graph LR
    A[GitHub Push] --> B[CI/CD]
    B --> C[npm install]
    C --> D[npm run build]
    D --> E[Deploy dist/]
    E --> F[CDN]
```

### **Backend (Supabase)**

```mermaid
graph LR
    A[Local Development] --> B[supabase functions deploy]
    B --> C[Edge Function Runtime]
    C --> D[Deno]
```

### **Database (Supabase)**

```mermaid
graph LR
    A[Local Migrations] --> B[supabase db push]
    B --> C[PostgreSQL]
    C --> D[RLS Policies]
```

---

## ๐งฉ Componentes y Responsabilidades

### **App.tsx** (Orquestador)
- โ Estado global de la aplicaciรณn
- โ Maneja autenticaciรณn
- โ Maneja lista de productos escaneados
- โ Coordina componentes hijos
- โ Loading states

### **LoginScreen.tsx** (Autenticaciรณn)
- โ Formulario de login
- โ Validaciรณn de campos
- โ Manejo de errores
- โ Estados de carga
- โ UI profesional

### **ProductScanner.tsx** (Input)
- โ Dos modos: Manual y Escรกner
- โ Validaciรณn de UPC
- โ Submit handler
- โ Estados de carga
- โ AutoFocus para escรกneres

### **ProductDetails.tsx** (Visualizaciรณn)
- โ Muestra producto actual
- โ Iconos para campos
- โ Maneja campos opcionales
- โ Responsive

### **ProductTable.tsx** (Lista)
- โ Tabla de productos
- โ Eliminar productos
- โ Estado vacรญo
- โ Responsive (oculta columnas en mรณvil)
- โ Numeraciรณn automรกtica

### **authService.ts** (Servicio)
- โ Login con Supabase
- โ Logout
- โ Obtener empleado actual
- โ Validaciรณn de empleado activo
- โ Update last_login

### **productService.ts** (Servicio)
- โ Fetch product data
- โ Comunica con Edge Function
- โ Manejo de errores

### **csvExport.ts** (Utilidad)
- โ Convierte a CSV
- โ UTF-8 con BOM
- โ Headers en espaรฑol
- โ Descarga automรกtica

### **Edge Function: product-lookup** (Backend)
- โ Busca en mรบltiples APIs
- โ Genera precios realistas
- โ Enriquece con IA (OpenAI)
- โ Fallback robusto
- โ CORS configurado

---

## ๐ Estado de la Aplicaciรณn

### **Estado Global (App.tsx)**
```typescript
{
  employee: Employee | null,        // Usuario logueado
  isAuthLoading: boolean,           // Loading inicial de sesiรณn
  isLoginLoading: boolean,          // Loading durante login
  scannedProducts: Product[],       // Lista de productos
  currentProduct: Product | null,   // Producto actual mostrado
  isLoading: boolean                // Loading durante bรบsqueda
}
```

### **Flujo de Estados**

```
1. Inicio โ isAuthLoading=true
              โ
   checkSession()
              โ
   employee != null โ Interfaz principal
   employee == null โ LoginScreen

2. Login โ isLoginLoading=true
              โ
   loginEmployee()
              โ
   employee actualizado โ Interfaz principal

3. Bรบsqueda โ isLoading=true
              โ
   fetchProductData()
              โ
   currentProduct actualizado
   scannedProducts actualizado
              โ
   isLoading=false

4. Logout โ logoutEmployee()
              โ
   employee=null
   scannedProducts=[]
   currentProduct=null
              โ
   LoginScreen
```

---

## ๐ฆ Dependencias Crรญticas

### **Producciรณn**

| Librerรญa | Versiรณn | Uso |
|----------|---------|-----|
| React | 18.3.1 | Framework UI |
| @supabase/supabase-js | 2.57.4 | Backend client |
| lucide-react | 0.344.0 | Iconos |

### **Desarrollo**

| Librerรญa | Versiรณn | Uso |
|----------|---------|-----|
| Vite | 7.1.9 | Build tool |
| TypeScript | 5.5.3 | Lenguaje |
| TailwindCSS | 3.4.1 | Styling |
| ESLint | 9.9.1 | Linter |

---

## ๐ APIs Externas

### **1. OpenFoodFacts**
- **URL**: `https://world.openfoodfacts.org/api/v0/product/{upc}.json`
- **Autenticaciรณn**: No requerida
- **Rate limit**: Ilimitado
- **Datos**: Productos alimenticios

### **2. UPCItemDB**
- **URL**: `https://api.upcitemdb.com/prod/trial/lookup?upc={upc}`
- **Autenticaciรณn**: No requerida (trial)
- **Rate limit**: 100 requests/dรญa (trial)
- **Datos**: Productos generales

### **3. OpenAI**
- **Modelo**: GPT-4o-mini
- **Uso**: Generaciรณn de descripciones
- **Costo**: ~$0.15 por 1M tokens
- **API Key**: En Supabase Secrets

---

## ๐จ Sistema de Diseรฑo

### **Paleta de Colores**

```css
/* Primary */
--orange-500: #F97316
--orange-600: #EA580C
--amber-600: #D97706

/* Neutral */
--slate-50: #F8FAFC
--slate-100: #F1F5F9
--slate-200: #E2E8F0
--slate-600: #475569
--slate-700: #334155
--slate-800: #1E293B

/* Semantic */
--red-600: #DC2626 (eliminar)
--green-600: #16A34A (รฉxito)
```

### **Tipografรญa**

```css
/* Headings */
h1: text-2xl sm:text-3xl md:text-4xl
h2: text-lg sm:text-xl md:text-2xl

/* Body */
text-sm: 0.875rem
text-base: 1rem

/* Weights */
font-medium: 500
font-semibold: 600
font-bold: 700
```

### **Espaciado**

```css
/* Padding */
p-2: 0.5rem
p-4: 1rem
p-6: 1.5rem
p-8: 2rem

/* Margin */
mb-4: 1rem
mb-6: 1.5rem
```

### **Breakpoints**

```css
sm: 640px   /* Tablet */
md: 768px   /* Desktop pequeรฑo */
lg: 1024px  /* Desktop */
```

---

## โ Checklist de Arquitectura

### **Frontend**
- [x] Componentes modulares
- [x] Separaciรณn de concerns
- [x] Tipos TypeScript
- [x] Manejo de errores
- [x] Estados de carga
- [x] Responsive design
- [ ] Tests unitarios
- [ ] Tests de integraciรณn

### **Backend**
- [x] Base de datos relacional
- [x] RLS habilitado
- [x] Edge Function desplegada
- [x] CORS configurado
- [x] Manejo de errores
- [ ] Rate limiting custom
- [ ] Logs centralizados

### **Seguridad**
- [x] Variables de entorno
- [x] RLS en base de datos
- [x] JWT tokens
- [x] API keys server-side
- [ ] HTTPS enforcement
- [ ] Input sanitization

### **Performance**
- [x] Bundle optimizado
- [x] CSS purging
- [x] Tree shaking
- [ ] Code splitting
- [ ] Service worker (PWA)
- [ ] Cachรฉ estrategia

### **DevOps**
- [x] Build automatizado
- [x] TypeScript check
- [ ] Tests automatizados
- [ ] CI/CD pipeline
- [ ] Staging environment
- [ ] Monitoring/logging

---

## ๐ง Prรณximos Pasos

1. **Tests** - Implementar Vitest + React Testing Library
2. **PWA** - Service worker y manifest
3. **Cache** - LocalStorage para productos buscados
4. **Monitoring** - Sentry para error tracking
5. **Analytics** - Track uso de la aplicaciรณn
6. **Logs** - Centralizar logs de Edge Function
7. **Rate Limiting** - Implementar en Edge Function
8. **Optimizaciรณn** - Code splitting con React.lazy()

---

**Documento de arquitectura** - Versiรณn 1.0
**รltima actualizaciรณn**: 2024
